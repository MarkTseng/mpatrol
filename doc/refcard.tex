% mpatrol
% A library for controlling and tracing dynamic memory allocations.
% Copyright (C) 1997-2000 Graeme S. Roy <graeme@epc.co.uk>
%
% This library is free software; you can redistribute it and/or
% modify it under the terms of the GNU Library General Public
% License as published by the Free Software Foundation; either
% version 2 of the License, or (at your option) any later version.
%
% This library is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% Library General Public License for more details.
%
% You should have received a copy of the GNU Library General Public
% License along with this library; if not, write to the Free
% Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
% MA 02111-1307, USA.

% LaTeX reference card for mpatrol

% $Id: refcard.tex,v 1.4 2000-07-16 23:53:27 graeme Exp $

\documentclass[a4paper,landscape,final]{article}

\usepackage{multicol}

% Adapt the page dimensions to the paper size.

\setlength{\textwidth}{\paperwidth}
\addtolength{\textwidth}{-1in}
\setlength{\textheight}{\paperheight}
\addtolength{\textheight}{-1in}
\setlength{\headheight}{0in}
\setlength{\headsep}{0in}
\setlength{\footskip}{0in}
\setlength{\parindent}{0in}
\setlength{\columnsep}{.5in}

% Determine if a PDF file is being generated.

\ifx\pdfoutput\undefined
  \setlength{\oddsidemargin}{-.5in}
  \setlength{\evensidemargin}{-.5in}
  \setlength{\topmargin}{-.5in}
\else
  \pdfoutput=1
  \pdfcompresslevel=9
  \setlength{\oddsidemargin}{0in}
  \setlength{\evensidemargin}{0in}
  \setlength{\topmargin}{0in}
\fi

% Define new commands for formatting the headings and options.

\newcommand{\heading}[1]{\textbf{\normalsize #1}}
\newcommand{\command}[1]{\textbf{#1}}
\newcommand{\function}[1]{\texttt{#1()}}
\newcommand{\flag}[1]{\textbf{--#1}}
\newcommand{\flagpar}[2]{\flag{#1} \texttt{<}\textit{#2}\texttt{>}}
\newcommand{\option}[1]{\texttt{#1}}
\newcommand{\optionarg}[2]{\option{#1}\texttt{=<#2>}}
\newcommand{\optionpar}[2]{\option{#1}\texttt{=<}\textit{#2}\texttt{>}}

\begin{document}

\pagestyle{empty}

\footnotesize

\begin{multicols}{3}{\textbf{\Large mpatrol reference card}}

\vskip 12pt

The mpatrol library can read certain options at run-time from an environment
variable called \texttt{MPATROL\_OPTIONS}.  This variable must contain one or
more valid option keywords from the list below and must be no longer than 1024
characters in length.  If \texttt{MPATROL\_OPTIONS} is unset or empty then the
default settings will be used.

\vskip 12pt
\heading{Library behaviour}
\vskip 6pt

\begin{description}
\item[\option{HELP}]
Displays a quick-reference option summary.
\item[\optionpar{PROGFILE}{string}]
Specifies an alternative filename with which to locate the executable file
containing the program's symbols.
\item[\optionpar{CHECK}{unsigned range}]
Specifies a range of allocation indices at which to check the integrity of free
memory and overflow buffers.
\item[\optionpar{DEFALIGN}{unsigned integer}]
Specifies the default alignment for general-purpose memory allocations, which
must be a power of two.
\item[\option{NOPROTECT}]
Specifies that the mpatrol library's internal data structures should not be made
read-only after every memory allocation, reallocation or deallocation.
\item[\option{SAFESIGNALS}]
Instructs the library to save and replace certain signal handlers during the
execution of library code and to restore them afterwards.
\item[\option{USEMMAP}]
Specifies that the library should use \function{mmap} instead of \function{sbrk}
to allocate system memory on UNIX platforms.
\end{description}

\vskip 12pt
\heading{Logging and tracing}
\vskip 6pt

\begin{description}
\item[\optionpar{LOGFILE}{string}]
Specifies an alternative file in which to place all diagnostics from the mpatrol
library.
\item[\option{LOGALLOCS}]
Specifies that all memory allocations are to be logged and sent to the log file.
\item[\option{LOGREALLOCS}]
Specifies that all memory reallocations are to be logged and sent to the log
file.
\item[\option{LOGFREES}]
Specifies that all memory deallocations are to be logged and sent to the log
file.
\item[\option{LOGMEMORY}]
Specifies that all memory operations are to be logged and sent to the log file.
\item[\option{LOGALL}]
Equivalent to the \option{LOGALLOCS}, \option{LOGREALLOCS}, \option{LOGFREES}
and \option{LOGMEMORY} options specified together.
\item[\option{SHOWFREED}]
Specifies that a summary of all of the freed memory allocations should be
displayed at the end of program execution.
\item[\option{SHOWUNFREED}]
Specifies that a summary of all of the unfreed memory allocations should be
displayed at the end of program execution.
\item[\option{SHOWMAP}]
Specifies that a memory map of the entire heap should be displayed at the end of
program execution.
\item[\option{SHOWSYMBOLS}]
Specifies that a summary of all of the function symbols read from the program's
executable file should be displayed at the end of program execution.
\item[\option{SHOWALL}]
Equivalent to the \option{SHOWFREED}, \option{SHOWUNFREED}, \option{SHOWMAP} and
\option{SHOWSYMBOLS} options specified together.
\item[\option{USEDEBUG}]
Specifies that any debugging information in the executable file should be used
to obtain additional source-level information.
\end{description}

\vskip 12pt
\heading{General errors}
\vskip 6pt

\begin{description}
\item[\option{CHECKALLOCS}]
Checks that no attempt is made to allocate a block of memory of size zero.
\item[\option{CHECKREALLOCS}]
Checks that no attempt is made to reallocate a \texttt{NULL} pointer or resize
an existing block of memory to size zero.
\item[\option{CHECKFREES}]
Checks that no attempt is made to deallocate a \texttt{NULL} pointer.
\item[\option{CHECKALL}]
Equivalent to the \option{CHECKALLOCS}, \option{CHECKREALLOCS} and
\option{CHECKFREES} options specified together.
\item[\optionpar{ALLOCBYTE}{unsigned integer}]
Specifies an 8-bit byte pattern with which to prefill newly-allocated memory.
\item[\optionpar{FREEBYTE}{unsigned integer}]
Specifies an 8-bit byte pattern with which to prefill newly-freed memory.
\item[\optionpar{NOFREE}{unsigned integer}]
Specifies that a number of recently-freed memory allocations should be prevented
from being returned to the free memory pool.
\item[\option{PRESERVE}]
Specifies that any reallocated or freed memory allocations should preserve their
original contents.
\end{description}

\vskip 12pt
\heading{Overwrites and underwrites}
\vskip 6pt

\begin{description}
\item[\optionpar{OFLOWSIZE}{unsigned integer}]
Specifies the size in bytes to use for all overflow buffers, which must be a
power of two.
\item[\optionpar{OFLOWBYTE}{unsigned integer}]
Specifies an 8-bit byte pattern with which to fill the overflow buffers of all
memory allocations.
\item[\option{OFLOWWATCH}]
Specifies that watch point areas should be used for overflow buffers rather than
filling with the overflow byte.
\item[\optionarg{PAGEALLOC}{LOWER|UPPER}]
Specifies that each individual memory allocation should occupy at least one page
of virtual memory and should be placed at the lowest or highest point within
these pages.
\item[\option{ALLOWOFLOW}]
Specifies that a warning rather than an error should be produced if any memory
operation function overflows the boundaries of a memory allocation, and that
the operation should still be performed.
\end{description}

\vskip 12pt
\heading{Using with a debugger}
\vskip 6pt

\begin{description}
\item[\optionpar{ALLOCSTOP}{unsigned integer}]
Specifies an allocation index at which to stop the program when it is being
allocated.
\item[\optionpar{REALLOCSTOP}{unsigned integer}]
Specifies an allocation index at which to stop the program when a memory
allocation is being reallocated.
\item[\optionpar{FREESTOP}{unsigned integer}]
Specifies an allocation index at which to stop the program when it is being
freed.
\end{description}

\vskip 12pt
\heading{Testing}
\vskip 6pt

\begin{description}
\item[\optionpar{LIMIT}{unsigned integer}]
Specifies the limit in bytes at which all memory allocations should fail if the
total allocated memory should increase beyond this.
\item[\optionpar{FAILFREQ}{unsigned integer}]
Specifies the frequency at which all memory allocations will randomly fail.
\item[\optionpar{FAILSEED}{unsigned integer}]
Specifies the random number seed which will be used when determining which
memory allocations will randomly fail.
\item[\optionpar{UNFREEDABORT}{unsigned integer}]
Specifies the minimum number of unfreed allocations at which to abort the
program just before program termination.
\end{description}

\vskip 12pt
\heading{Profiling}
\vskip 6pt

\begin{description}
\item[\option{PROF}]
Specifies that all memory allocations are to be profiled and sent to the
profiling output file.
\item[\optionpar{PROFFILE}{string}]
Specifies an alternative file in which to place all memory allocation profiling
information from the mpatrol library.
\item[\optionpar{AUTOSAVE}{unsigned integer}]
Specifies the frequency at which to periodically write the profiling data to the
profiling output file.
\item[\optionpar{SMALLBOUND}{unsigned integer}]
Specifies the limit in bytes up to which memory allocations should be classified
as small allocations for profiling purposes.
\item[\optionpar{MEDIUMBOUND}{unsigned integer}]
Specifies the limit in bytes up to which memory allocations should be classified
as medium allocations for profiling purposes.
\item[\optionpar{LARGEBOUND}{unsigned integer}]
Specifies the limit in bytes up to which memory allocations should be classified
as large allocations for profiling purposes.
\end{description}

\end{multicols}

\pagebreak

\begin{multicols}{3}

\vskip 12pt

All of the function definitions in \texttt{mpatrol.h} can be disabled by
defining the \texttt{NDEBUG} preprocessor macro, which is the same macro used
to control the behaviour of the \function{assert} function.  If \texttt{NDEBUG}
is defined then no macro redefinition of functions will take place and all
special mpatrol library functions will evaluate to empty statements.  It is
intended that the \texttt{NDEBUG} preprocessor macro be defined in release
builds.

\vskip 12pt
\heading{C dynamic memory allocation functions}
\vskip 6pt

\begin{description}
\item[\function{malloc}]
\hfill Allocates memory.
\item[\function{calloc}]
\hfill Allocates zero-filled memory.
\item[\function{memalign}]
\hfill Allocates memory with a specified alignment.
\item[\function{valloc}]
\hfill Allocates page-aligned memory.
\item[\function{pvalloc}]
\hfill Allocates a number of pages.
\item[\function{strdup}]
\hfill Duplicates a string.
\item[\function{strndup}]
\hfill Duplicates a string with a maximum length.
\item[\function{strsave}]
\hfill Duplicates a string.
\item[\function{strnsave}]
\hfill Duplicates a string with a maximum length.
\item[\function{realloc}]
\hfill Resizes memory.
\item[\function{recalloc}]
\hfill Resizes memory allocated by \function{calloc}.
\item[\function{expand}]
\hfill Resizes memory but does not relocate it.
\item[\function{free}]
\hfill Frees memory.
\item[\function{cfree}]
\hfill Frees memory allocated by \function{calloc}.
\end{description}

\vskip 12pt
\heading{C$++$ dynamic memory allocation functions}
\vskip 6pt

\begin{description}
\item[\texttt{operator new}]
\hfill Allocates memory.
\item[\texttt{operator new[]}]
\hfill Allocates memory for an array.
\item[\texttt{operator delete}]
\hfill Frees memory.
\item[\texttt{operator delete[]}]
\hfill Frees memory allocated by \texttt{new[]}.
\item[\function{set\_new\_handler}]
\hfill Sets up an allocation failure handler.
\end{description}

\vskip 12pt
\heading{C memory operation functions}
\vskip 6pt

\begin{description}
\item[\function{memset}]
\hfill Fills memory with a specific byte.
\item[\function{bzero}]
\hfill Fills memory with the zero byte.
\item[\function{memccpy}]
\hfill Copies memory up to a specific byte.
\item[\function{memcpy}]
\hfill Copies non-overlapping memory.
\item[\function{memmove}]
\hfill Copies possibly-overlapping memory.
\item[\function{bcopy}]
\hfill Copies possibly-overlapping memory.
\item[\function{memcmp}]
\hfill Compares two blocks of memory.
\item[\function{bcmp}]
\hfill Compares two blocks of memory.
\item[\function{memchr}]
\hfill Searches memory for a specific byte.
\item[\function{memmem}]
\hfill Searches memory for specific bytes.
\end{description}

\vskip 12pt
\heading{mpatrol library functions}
\vskip 6pt

\begin{description}
\item[\function{\_\_mp\_info}]
\hfill Returns information for an allocation.
\item[\function{\_\_mp\_printinfo}]
\hfill Displays information for an allocation.
\item[\function{\_\_mp\_memorymap}]
\hfill Displays a map of memory in the heap.
\item[\function{\_\_mp\_summary}]
\hfill Displays a summary of library statistics.
\item[\function{\_\_mp\_check}]
\hfill Validates memory in the heap.
\item[\function{\_\_mp\_prologue}]
\hfill Sets up an allocation prologue handler.
\item[\function{\_\_mp\_epilogue}]
\hfill Sets up an allocation epilogue handler.
\item[\function{\_\_mp\_nomemory}]
\hfill Sets up an allocation failure handler.
\end{description}

\vskip 12pt

The commands that are distributed with the mpatrol library all parse their
command line options in a similar way to the UNIX \function{getopt} function.
Options that accept numeric arguments can have their value specified in binary,
octal, decimal or hexadecimal notation.

\vskip 12pt
\heading{mpatrol command options}
\vskip 6pt

\begin{description}
\item[\flagpar{1}{unsigned integer}]
\hfill See \option{SMALLBOUND}.
\item[\flagpar{2}{unsigned integer}]
\hfill See \option{MEDIUMBOUND}.
\item[\flagpar{3}{unsigned integer}]
\hfill See \option{LARGEBOUND}.
\item[\flagpar{A}{unsigned integer}]
\hfill See \option{ALLOCSTOP}.
\item[\flagpar{a}{unsigned integer}]
\hfill See \option{ALLOCBYTE}.
\item[\flagpar{C}{unsigned range}]
\hfill See \option{CHECK}.
\item[\flag{c}]
\hfill See \option{CHECKALL}.
\item[\flagpar{D}{unsigned integer}]
\hfill See \option{DEFALIGN}.
\item[\flag{d}]
Specifies that programs which were not linked with the mpatrol library should
also be traced, but only if they were dynamically linked.
\item[\flagpar{e}{string}]
\hfill See \option{PROGFILE}.
\item[\flagpar{F}{unsigned integer}]
\hfill See \option{FREESTOP}.
\item[\flagpar{f}{unsigned integer}]
\hfill See \option{FREEBYTE}.
\item[\flag{G}]
\hfill See \option{SAFESIGNALS}.
\item[\flag{g}]
\hfill See \option{USEDEBUG}.
\item[\flagpar{L}{unsigned integer}]
\hfill See \option{LIMIT}.
\item[\flagpar{l}{string}]
\hfill See \option{LOGFILE}.
\item[\flag{M}]
\hfill See \option{ALLOWOFLOW}.
\item[\flag{m}]
\hfill See \option{USEMMAP}.
\item[\flag{N}]
\hfill See \option{NOPROTECT}.
\item[\flagpar{n}{unsigned integer}]
\hfill See \option{NOFREE}.
\item[\flagpar{O}{unsigned integer}]
\hfill See \option{OFLOWSIZE}.
\item[\flagpar{o}{unsigned integer}]
\hfill See \option{OFLOWBYTE}.
\item[\flagpar{P}{string}]
\hfill See \option{PROFFILE}.
\item[\flag{p}]
\hfill See \option{PROF}.
\item[\flagpar{Q}{unsigned integer}]
\hfill See \option{AUTOSAVE}.
\item[\flagpar{R}{unsigned integer}]
\hfill See \option{REALLOCSTOP}.
\item[\flag{S}]
\hfill See \option{SHOWMAP} and \option{SHOWSYMBOLS}.
\item[\flag{s}]
\hfill See \option{SHOWFREED} and \option{SHOWUNFREED}.
\item[\flagpar{U}{unsigned integer}]
\hfill See \option{UNFREEDABORT}.
\item[\flag{V}]
Displays the version number of the \command{mpatrol} command.
\item[\flag{v}]
\hfill See \option{PRESERVE}.
\item[\flag{w}]
\hfill See \option{OFLOWWATCH}.
\item[\flag{X}]
\hfill See \option{PAGEALLOC=UPPER}.
\item[\flag{x}]
\hfill See \option{PAGEALLOC=LOWER}.
\item[\flagpar{Z}{unsigned integer}]
\hfill See \option{FAILSEED}.
\item[\flagpar{z}{unsigned integer}]
\hfill See \option{FAILFREQ}.
\end{description}

\vskip 12pt
\heading{mprof command options}
\vskip 6pt

\begin{description}
\item[\flag{a}]
Specifies that different call sites from within the same function are to be
differentiated and that the names of all functions should be displayed with
their call site offset in bytes.
\item[\flag{c}]
Specifies that certain tables should be sorted by the number of allocations or
deallocations rather than the total number of bytes allocated or deallocated.
\item[\flagpar{n}{depth}]
Specifies the maximum stack depth to use when calculating if one call site has
the same call stack as another call site.  This also specifies the maximum
number of functions to display in a call stack.
\item[\flag{V}]
Displays the version number of the \command{mprof} command.
\end{description}

\vskip 12pt
\heading{mleak command options}
\vskip 6pt

\begin{description}
\item[\flag{V}]
Displays the version number of the \command{mleak} command.
\end{description}

\vskip 12pt
Copyright \copyright 1997-2000 Graeme S. Roy.
\vskip 6pt

This reference card may be freely distributed under the terms of the GNU General
Public License.

\end{multicols}

\end{document}
